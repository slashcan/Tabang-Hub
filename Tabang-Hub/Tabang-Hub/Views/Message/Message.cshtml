@model Tabang_Hub.Utils.Lists
@if (Model.userAccount != null && Model.userAccount.roleId == 2)
{
    ViewBag.Title = "Message";
    Layout = "~/Views/Shared/_Organization.cshtml";
}
else
{
    ViewBag.Title = "Message";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/Css/message.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="message-body">
    <div class="chat-list">
        <div class="chat-item-head">
            <h2>Group Chats</h2>
        </div>
        @if (Model.listOfGc == null || Model.listOfGc.Count().Equals(0))
        {
            <script type="text/javascript">
                Swal.fire({
                    icon: 'info',
                    title: 'No Group Chats available!',
                    text: 'Group chat will appear if you join an event.',
                    allowOutsideClick: false, // Prevent closing by clicking outside
                    allowEscapeKey: false,    // Prevent closing by pressing escape key
                    confirmButtonText: 'OK'   // Custom button text
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("Index", "Page")'; // Redirect to Index page
                    }
                });
            </script>
        }
        else
        {
            foreach (var gc in Model.listOfGc)
            {
                <div class="chat-item" onclick="selectGroup('@gc.groupChatId', event)">
                    @{
                        var gcImage = Model.detailsEventImage.Where(m => m.eventId == gc.eventId).Select(m => m.eventImage).FirstOrDefault();
                    }
                    <img src="@Url.Content("~/Content/Events/" + gcImage)" alt="Profile">
                    <span>@gc.eventTitle</span>
                    <input type="hidden" value="@gc.groupChatId" id="groupId" />
                    <input type="hidden" value="@gc.userId" id="userId" />
                </div>

            }
        }
    </div>

    <!-- Chat area for displaying messages -->
    <div class="chat-area">
        <div class="messages"></div>
        <div class="message-input">
            <input type="text" id="message" placeholder="Type a message">
            <button id="sendmessage">Send</button>
        </div>
    </div>
</div>

<script type="text/javascript">

    var currentUserId = '@ViewBag.UserId'.toString();
    console.log("currentUserId: ", currentUserId);

    var selectedGcID = null;
    function selectGroup(groupId, event) {
        console.log("Group ID: ", groupId);

        // Remove 'selected' class from any previously selected item
        $('.chat-item').removeClass('selected');

        // Add 'selected' class to the clicked item
        $(event.currentTarget).addClass('selected');

        selectedGcID = groupId;

        document.getElementById('message').disabled = false;
        document.getElementById('sendmessage').disabled = false;

        // Start SignalR connection when a group is selected
        $.connection.hub.start().done(function () {
            var chat = $.connection.chatHub;
            console.log(currentUserId);
            // Load existing messages for the selected group
            chat.server.getAllMessages(selectedGcID);

            // Send a message when the send button is clicked
            $('#sendmessage').click(function () {
                var message = $('#message').val();
                if (message) {
                    chat.server.send(currentUserId, selectedGcID, message);
                    $('#message').val('').focus(); // Clear the input and refocus
                }
            });
        });
    }


    $(function () {
        // Declare a proxy to reference the hub
        var chat = $.connection.chatHub;

        // Notify when the group chat does not exist
        chat.client.groupChatNotFound = function () {
            Swal.fire({
                icon: 'error',
                title: 'Group Chat Not Found!',
                text: 'The group chat you are trying to access does not exist.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                confirmButtonText: 'OK'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#message').val(''); // Clear the message input
                    location.reload();
                }
            });
        };


        if (selectedGcID == null) {
            document.getElementById('message').disabled = true;
            document.getElementById('sendmessage').disabled = true;
        }
        // Function to display a message (appends to the chat-area)
        chat.client.broadcastMessage = function (userName, senderId, message, groupId) {
            var messageClass = senderId.toString() === currentUserId ? 'sent' : 'received';

            var messageHtml = '<div class="message-container ' + messageClass + '">';
            if (messageClass === 'received') {
                messageHtml += '<strong class="user-name">' + userName + '</strong>';
            }
            messageHtml += '<div class="message ' + messageClass + '"><span>' + htmlEncode(message) + '</span></div>';
            messageHtml += '</div>';

            // Append the message to the chat area
            $('.messages').append(messageHtml);

            // Auto-scroll to the bottom after adding the message
            $('.messages').scrollTop($('.messages')[0].scrollHeight);
        };

        // Function to load all previous messages when the page loads
        chat.client.loadMessages = function (messages) {
            $('.messages').empty(); // Clear the current messages
            $.each(messages, function (index, message) {
                var messageClass = message.userId.toString() === currentUserId ? 'sent' : 'received';

                var messageHtml = '<div class="message-container ' + messageClass + '">';
                if (messageClass === 'received') {
                    messageHtml += '<strong class="user-name">' + message.userName + '</strong>';
                }
                messageHtml += '<div class="message ' + messageClass + '"><span>' + htmlEncode(message.message) + '</span></div>';
                messageHtml += '</div>';

                // Append the message to the chat area
                $('.messages').append(messageHtml);
            });

            // Auto-scroll to the bottom after loading messages
            $('.messages').scrollTop($('.messages')[0].scrollHeight);
        };

        // Utility function to encode HTML special characters
        function htmlEncode(value) {
            return $('<div />').text(value).html();
        }
    });
</script>